# 清除 | 符

```php
<?php
    if(is_array($art['content'])){
        $art['content'] = implode("|",$art['content']);
    }
?>
```

# 把文本框得  |  解析成任意符号

```php
<?php $label_arr = explode("|", $article['title']);?>
{foreach name="label_arr" item="val" key="n"}
{if $n !=0} | {/if}
{$val}
{/foreach}
```

# 换行解析成 P，栏目，列表，详情同理

```php
<?php $label_arr = explode("\n", $cat['desc_text']);?>
{foreach name="label_arr" item="val" key="n"}
<p>{$val}</p>
{/foreach}

// 调取内容直接将 | 解析成 p【这个可以防止报错，上面报错可以尝试他】
<?php
$label_arr = explode("|", implode("|", $article['miaoshusd']));
?>
{foreach $label_arr as $n => $val}
<p>
    {$val|raw|nl2br}
</p>
{/foreach}
```

# 直接调取栏目id将换行解析成 P

```php
<?php
$desc = $function->getCatInfo('17')['desc_text'];
$desc = preg_replace('/(.+?)(\r\n|\r|\n|$)/', '<p>$1</p>', $desc);
echo $desc;
?>
```

# 直接调取栏目id将 #123#解析成<span>123</span> 

```php
<?php
$desc = $function->getCatInfo('1')['fenlei1'];
$desc = preg_replace('/#(.*?)#/', '<span>$1</span>', $desc);
echo $desc;
?>

/** 回车解析成<br> **/
<?php
$desc = $function->getCatInfo('1')['fenlei1'];
$desc = preg_replace('/#(.*?)#/', '<span>$1</span>', $desc);
$desc = preg_replace('/\r\n|\r|\n/', '<br>', $desc);
echo $desc;
?>
```

# 循环将#号  #123#解析成<span>123</span> 

```php
<?php
$label_arr = explode("#", $art['subtitle']);
for ($i = 0; $i < count($label_arr); $i++) {
    if ($i % 2 == 0) {
        echo htmlspecialchars($label_arr[$i]);
    } else {
        echo "<span>" . htmlspecialchars($label_arr[$i]) . "</span>";
    }
    echo "<br>";
}
?>
```

# 获取每个栏目下的内容数量是否大于4

```php
<?php 
$articleCount = count($function->getCatArticle($childValue['id']));
if ($articleCount > 4) {
?>
    <?php foreach ($function->getCatArticle($childValue['id']) as $n => $art): ?>
     //展示内容，因为计数大于4
    <?php endforeach; ?>
    <?php } else { ?>
    //如果计数不大于4，可以在这里添加其他逻辑或提示
<?php } ?>
```

# 获取每个栏目下的内容数量是否大于4 添加class

```php
<?php 
    $articleCount = count($function->getCatArticle($childValue['id']));
    $additionalClass = ($articleCount > 4) ? ' extra-class' : ''; // 根据条件确定是否有额外的class类
?>
<?php foreach ($function->getCatArticle($childValue['id']) as $n => $art): ?>
    <div class="nav_Mounk<?php echo $additionalClass; ?>">
        <a href="/index/Article/show/cat_id/{$art.cat_id}/id/{$art.id}">
            <img src="{$art.logol}" alt="">
            <p>{$art.title}</p>
        </a>
    </div>
<?php endforeach; ?>
```

# 循环li，每三个li外边包一个div

```php
{volist name="function->getCatArticle('11')" id="art" key="n"}
    {if ($n - 1) % 3 == 0}
    <div class="outer-container">
    {/if}
    <li>
	</li>
    {if $n % 3 == 0 || $n == count($function->getCatArticle('11'))}
    </div>
    {/if}
{/volist}
```

# 栏目调取富文本

```php
<div class="layui-row margin-bottom-15">
    <label class="layui-col-xs2 think-form-label">分类描述</label>
    <label class="layui-col-xs10">
        <style type="text/css">
            .clear {
                clear: both;
            }
        </style>
        <textarea id="fenlei5" type="text/plain" name="fenlei5" style="width:100%;height:300px;">{$vo.fenlei5|default=''|raw}</textarea>
    </label>  
    <script>
        window.form.render();
        require(['ckeditor'], function () {
            window.createEditor('[name=desc_text]', { height: 250 });
        });
    </script>
</div>
```

# 获取当前地址

```php
// 放在页面在上方
<?php
    $protocol = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off') || $_SERVER['SERVER_PORT'] == 443) ? "https://": "http://";
    $pageURL  = $protocol . $_SERVER["SERVER_NAME"] . $_SERVER["REQUEST_URI"];
?>
//调用
{$pageURL}
```

# 获得文件大小

```php
//处理列表增加链接项
foreach ($list AS $key => $value){
    $list[$key]['url'] = "site-".$linkName."/show-".$value['cat_id']."-".$value['id'].".html";
    foreach ($value AS $k => $v){
        if (!empty($v) && strpos($v, "|") !== false) {
            //处理字段内是否有“|”符号，如果有则拆分成数组
            $list[$key][$k] = explode("|", $v);
        }
    }
    // 获取文件大小
    $list[$key]['file_size'] = 0;  // 默认大小
    if (!empty($value['wenjian'])) {
        // 去掉 URL 协议和域名部分，保留相对路径
        $parsedUrl = parse_url($value['wenjian'], PHP_URL_PATH);
        
        // 拼接相对路径为绝对路径
        $filePath = $_SERVER['DOCUMENT_ROOT'] . $parsedUrl;  

        // 检查文件是否存在或可读
        if (file_exists($filePath) && is_readable($filePath)) {
            $list[$key]['file_size'] = filesize($filePath);
        }
    }
}
```

# 多选前端调用

```php
// 列表页
<?php
    $atc['a4'] = str_replace("|",",",$atc['a4']);
?>
// 列表页前端调用
{$atc.a4|raw|nl2br}

// 详情页
<?php
    if(is_array($article['gonglv'])){
        $article['gonglv'] = implode("",$article['gonglv']);
    }else{
        $article['gonglv'] = str_replace("|",",",$article['gonglv']);
    }
?>
// 详情页前端调用
{$article.a4|raw|nl2br}
```

# 详情页再跳详情页

```php
// /site-List/show_anli-{$article.cat_id}-{$article.id}.html  //跳转链接
// 需要增加对应路由 Route::rule('site-<listName>/show_anli-<cat_id>-<id>','index/article/show_anli');

// Article.php
public function show_anli()
{
    $id = $this->request->param('id');
    $id = empty($id) ? 0 : $id;
    $this->assign('id', $id);
    $catId = $this->request->param('cat_id');
    $catId = empty($catId) ? 0 : $catId;
    $this->assign('catId', $catId);
    $article = Db::name('data_article_show_zhuanyeku')->where('id', $id)->find(); //对应数据表
    if ($article) {
        $this->assign('article', $article);
    } else {
        $this->assign('article', []);
    }
    return $this->fetch();
}
```

# 前端添加加404页面

```php
vendor > topthink > framework > src >  tpl  >  think_exception.tpl
// 在第二行添加
header('Location:http://域名/404.html');
dump(1111);die; 
// 项目根目录放自己的404.html
```

# 首次访问要打开指定页面

```php
// index.php
public function index()
{
    //根据session判断是否首次进入首页
    $isFirst = $this->app->session->get('first');
    if(empty($isFirst)){
        //如果没有sesion记录，存session记录并直接跳进对应展示页
        $this->app->session->set('first',1);
        $this->redirect(sysuri('/site-List-2.html'));
    }
    return $this->fetch();
}
```

# 带参数的路由设置

```php
// 修改 ⇎ app/index/route/index.php
// 设置栏目 ⇎ http://域名/index/Article/list/id/2 为 http://域名/about 
Route::rule('about','index/Article/list')->append(['id'=>2]);
// 设置单页 ⇎ http://域名index/article/show/cat_id/26/id/1 为 http://域名/contact 
Route::rule('contact','index/article/show')->append(['cat_id'=>26, 'id'=>1]);
// 后台对应的栏目需要设置对应的跳转链接，比如ID为2的栏目，ID为2的栏目设置跳转链接为 /about

// 动态获取路由， 在data_article_cate数据表中添加custom_url字段【可以直接用force_link字段】
use think\facade\Db;
$routes = Db::name('data_article_cate')->select();
foreach ($routes as $route) {
    $url = $route['custom_url'];
    $id = $route['id'];

    if (is_string($url) && !empty($url)) {
        Route::rule($url, 'index/Article/list')->append(['id' => $id]);
    }
}
```

# 广告位信息

```php
{$function->getAdPosition('广告位ID')['title']}      // 广告位名称  
{$function->getAdPosition('广告位ID')['desc_text']}  // 广告位描述
{$function->getAd('3')['ad_img']}                   // 直接调用广告信息

{foreach name="function->getAllAd('广告位ID')" key="n" item="ad"}
{/foreach}
{$ad.title}                 // 广告名称
{$ad.ad_img}                // 广告图片链接 
{$ad.ad_text|raw|nl2br}     // 广告描述文字(多行文本需要在字段名字后边加raw和nl2br用来把多行文本里的换行转成html码并解析出来)
{$ad.ad_file}               // 广告视频
{$ad.url}                   // 跳转链接
```

# 关联

```php
// Article.php
/** 查找 获得当前图文信息 **/
$article = Db::name($contentTemplateInfo['table_name'])->where('id', $id)->find();
foreach ($article as $k => $v) {
    if (!empty($v) && strpos($v, "|") !== false) {
        //处理字段内是否有“|”符号，如果有则拆分成数组
        $article[$k] = explode("|", $v);
    }
}
if (!empty($article['associated'])) {
    //如果存在关联内容
    $associated = json_decode($article['associated'], true);
    $article['associatedList'] = Db::name($associated['tableName'])
        ->where('id', 'IN', $associated['id'])->order('sort desc,id desc')
        ->select()->toArray();
} else {
    $article['associatedList'] = [];
}
$this->assign('article',$article);

/** 前端 **/
{foreach name="article.associatedList" item="val"}
{/foreach}
```

# 筛选

## ♬筛选循环

```php
{foreach name="filterList" item="field"}
<?php $filedName = $field['field_name'];?>
<ul>
    <p>{$field.field_other_name}</p>
    <li class="getSelect {if (isset($$filedName)&& $$filedName == '0') || !isset($$filedName)} selected {/if}"
                data-name="{$field.field_name}" data-value="0">全部</li>
    {foreach name="field.filter" item="flt"}
    <li class="{if isset($$filedName)&& $$filedName == $flt.value}selected{/if}"><a class="getSelect" data-name="{$filedName}" data-value="{$flt.value}">{$flt.name}</a></li>
    {/foreach}
</ul>
{/foreach}
```

## ♬单个筛选

```php
<div class="fenlei">
    {foreach name="filterList" item="field"}
    <?php $filedName = $field['field_name'];?>
    {if $field['field_name']== 'fenlei'}
    <ul>
        <li class="getSelect {if (isset($$filedName)&& $$filedName == '0') || !isset($$filedName)} selected {/if}" data-name="fenlei" data-value="0">全部</li>
        {foreach name="field.filter" item="flt"}
        <li class="getSelect {if isset($$filedName)&& $$filedName == $flt.value}selected{/if}" data-name="{$filedName}" data-value="{$flt.value}">{$flt.name}</li>
        {/foreach}
    </ul>
    {/if}
    {/foreach}
</div>
```

## ♬JS⋙简化版

```php
<script>
    document.querySelectorAll(".getSelect").forEach(function (element) {
        element.addEventListener("click", function () {
            const id = {$catId};
            const name = this.getAttribute("data-name");
            const value = this.getAttribute("data-value");
            const url = new URL(`/site-List-${id}.html`, window.location.origin);
            const currentParams = new URLSearchParams(window.location.search);

            if (!currentParams.has('filter')) {
                currentParams.set('filter', '1');
            }
            if (this.classList.contains('selected')) {
                currentParams.delete(name);
            } else {
                currentParams.set(name, value);
            }
            url.search = currentParams.toString();
            window.location.href = url.toString();
        });
    });
</script>
```

## ♬JS⋙正常版

```php
<script>
     $(".getSelect").click(function (){
        var id = {$catId};
        var name = $(this).data("name")
        var value = $(this).data("value")
        var oldUrl = location.href;
        var url = "/index/article/list/id/"+id + "?filter=1";
        if(!getUrlParams('filter')){
            oldUrl = oldUrl + "?filter=1";
        }
        if(getUrlParams(name)) {
            url = UpdateUrlPriceParam(name, value);
        }else{
            url = oldUrl + "&"+name+"="+value;
        }
        window.location.href = url;
    });
    function getUrlParams(key) {
        var url = window.location.search.substr(1);
        if (url == '') {
            return false;
        }
        var paramsArr = url.split('&');
        for (var i = 0; i < paramsArr.length; i++) {
            var combina = paramsArr[i].split("=");
            if (combina[0] == key) {
                return combina[1];
            }
        }
        return false;
    }
    function UpdateUrlPriceParam(name, val) {
        var thisURL = document.location.href;
        if (thisURL.indexOf(name+'=') > 0) {
            var v = getUrlParams(name);
            if (v != null) {
                thisURL = thisURL.replace(name + '=' + v, name + '=' + val);
            }    
        }
        return thisURL;
    };
</script>
```

# 排序

## ♬排序方法

```php
$sortOrder = 'sort desc, create_at desc';
if ($this->request->param('is_sort') == 1) {
    if ($this->request->param('sort')) {
        $sortParam = $this->request->param('sort');
        $sortName = substr($sortParam, 0, strrpos($sortParam, ","));
        $sortValue = substr($sortParam, strripos($sortParam, ",") + 1);

        $this->assign('sortType', $sortName);
        
        if ($sortName == 'jine') {  //继续复制他 jiage位字段名  首字母大写
            $sortOrder = "CAST(`jine` AS SIGNED) {$sortValue}, id desc";
            $this->assign('sortValueJiage', $sortValue);
        } else {
            $sortOrder = $sortName . " " . $sortValue . ", id desc";
        }
    }
}

$list = DB::table($prefix . $contentTemplateInfo['table_name'])->json(["filter"])
->where($where)->where($whereGet)
// 使用修改后的排序规则
->orderRaw($sortOrder) // 使用orderRaw以支持SQL函数
->paginate(['list_rows' => $pageNum, 'query' => request()->param()])
->each(function ($item, $key) {
    return $item;
});
```

## ♬正序倒序分开两个按钮

```php
<ul>
    <?php
    $current_url = $_SERVER['REQUEST_URI'];
    $target_url = '/site-List-'.$catId.'.html';
    if ($current_url !== $target_url) {
        echo '<li><a href="'.$target_url.'">默认排序</a></li>';
    }else{
        echo '<li class="PanXu_Nav"><a href="'.$target_url.'">默认排序</a></li>';
    }
    ?>
    <li class="shengxu {if (isset($sortValueJiage) && $sortValueJiage == 'asc')} PanXu_Nav{/if}" data-name="sort" data-param="jine" data-value="{$sortValueJiage|default='desc'}">价格升序</li>
    <li class="jiangxu {if (isset($sortValueJiage) && $sortValueJiage == 'desc')} PanXu_Nav{/if}" data-name="sort" data-param="jine" data-value="{$sortValueJiage|default='desc'}">价格降序</li>
</ul>

<script>
    $(".jiangxu").click(function (){
       var id = {$catId};
       var name = $(this).attr("data-name")
       var params = $(this).attr("data-param")
       var value = $(this).attr("data-value")
        value = "desc";
       var oldUrl = location.href;

       value = params+","+value;
       var url = "/index/article/list/id/"+id + "?is_sort=1";
       if(!getUrlParams('is_sort')){
           oldUrl = oldUrl + "?is_sort=1";
       }
       if(getUrlParams(name)) {
           url = UpdateUrlPriceParam(name, value);
       }else{
           url = oldUrl + "&"+name+"="+value;
       }
       window.location.href = url;
   });
   $(".shengxu").click(function (){
       var id = {$catId};
       var name = $(this).attr("data-name")
       var params = $(this).attr("data-param")
       var value = $(this).attr("data-value")
        value = "asc";
       var oldUrl = location.href;

       value = params+","+value;
       var url = "/index/article/list/id/"+id + "?is_sort=1";
       if(!getUrlParams('is_sort')){
           oldUrl = oldUrl + "?is_sort=1";
       }
       if(getUrlParams(name)) {
           url = UpdateUrlPriceParam(name, value);
       }else{
           url = oldUrl + "&"+name+"="+value;
       }
       window.location.href = url;
   });
   function getUrlParams(key) {
        var url = window.location.search.substr(1);
        if (url == '') {
            return false;
        }
        var paramsArr = url.split('&');
        for (var i = 0; i < paramsArr.length; i++) {
            var combina = paramsArr[i].split("=");
            if (combina[0] == key) {
                return combina[1];
            }
        }
        return false;
    }
    function UpdateUrlPriceParam(name, val) {
        var thisURL = document.location.href;
        if (thisURL.indexOf(name+'=') > 0) {
            var v = getUrlParams(name);
            if (v != null) {
                thisURL = thisURL.replace(name + '=' + v, name + '=' + val);
            }    
        }
        return thisURL;
    };
</script>
```

## ♬一个按钮排序

```php
<a class="item getSort {if isset($sortType) && $sortType == 'subtitle'}active{/if}" data-name="sort" data-param="subtitle" data-value="{$sortValueSubtitle|default='desc'}">
    {if (isset($sortValueSubtitle) && $sortValueSubtitle == 'desc')}
    价格升序
    {else} 
    >价格降序
    {/if}
</a>

<script>
    $(".getSort").click(function () {
        var id = {$catId};
        var name = $(this).attr("data-name")
        var params = $(this).attr("data-param")
        var value = $(this).attr("data-value")
        if (value == "desc") {
            value = "asc";
        } else {
            value = "desc";
        }
        var oldUrl = location.href;
        value = params + "," + value;
        var url = "/index/article/list/id/" + id + "?is_sort=1";
        if (!getUrlParams('is_sort')) {
            oldUrl = oldUrl + "?is_sort=1";
        }
        if (getUrlParams(name)) {
            url = UpdateUrlPriceParam(name, value);
        } else {
            url = oldUrl + "&" + name + "=" + value;
        }
        window.location.href = url;
    });

    function getUrlParams(key) {
        var url = window.location.search.substr(1);
        if (url == '') {
            return false;
        }
        var paramsArr = url.split('&');
        for (var i = 0; i < paramsArr.length; i++) {
            var combina = paramsArr[i].split("=");
            if (combina[0] == key) {
                return combina[1];
            }
        }
        return false;
    }
    function UpdateUrlPriceParam(name, val) {
        var thisURL = document.location.href;
        if (thisURL.indexOf(name + '=') > 0) {
            var v = getUrlParams(name);
            if (v != null) {
                thisURL = thisURL.replace(name + '=' + v, name + '=' + val);    // 是否包含参数
            }
        }
        return thisURL;
    };
</script>
```

# 搜索

## ♬搜索基本用法

```php
<form action="/index/article/search" method="get">
    <select name="model">
        <option value="">请选择模型</option>
        {foreach name="modelList" item="model"}
            <option value="{$model.template_name}" {if isset($modelName)0 && $modelName == $model.template_name}selected{/if}>{$model.template_name}</option>
        {/foreach}
    </select>
    <input type="text" name="keyword" placeholder="{if isset($keyword)}{$keyword}{else}站内搜索{/if}"  class="seach_t" value="{if isset($keyword)}{$keyword}{/if}" />
    <input type="submit" value="搜索" class="seach_s" />
</form>

/** 未定义字段 搜索页循环里面加这段代码 **/
<?php
$art['字段名'] = isset($art['字段名'])?$art['字段名']:"";
?>
{if isset($keyword)}{$keyword}{/if}                                //搜索名称显示
{empty name="articleList"}无相关数据{/empty}                         //相关数据显示
<input type="hidden" name="model" value="模型名称">                 //指定模型搜索
title LIKE "%'.$keyword.'%" OR 自定义字段 LIKE "%'.$keyword.'%"      //搜索自定义字段
title = "'.$keyword.'" OR chengshi = "'.$keyword.'"                //精准搜索
/** 搜索自定义字段前端不显示或者报错【在下面数据库表添加对应得字段名】**/
data_article_show_default
/** 多内容模型搜索 **/
$tables = DB::query("show tables like '".$prefix."data_article_show_%'");  // 搜索所有内容模型数据表  替换为下方
$tables = Db::query("SELECT table_name FROM information_schema.tables WHERE table_name = ? OR table_name = ?", [$prefix.'data_article_show_moren', $prefix.'data_article_show_chanxun']);
```

## ♬在当前页面进行搜索，筛选下面加

```php
/** 多字段搜索 **/
$whereSearchTitle = [];
if($this->request->param('is_search')==1){
    if($this->request->param('keyword')){
        $whereSearch = " sousuo LIKE '%".$this->request->param('keyword')."%' ".
                        " OR title LIKE '%".$this->request->param('keyword')."%' ".
                        " OR keywords LIKE '%".$this->request->param('keyword')."%' ";
        $this->assign('keyword', $this->request->param('keyword'));
    }
}   
  
/** 单字段搜索 **/
$whereSearchTitle = "";
if($this->request->param('is_search')==1){
    if($this->request->param('keyword')){
        $whereSearchTitle = " title LIKE '%".$this->request->param('keyword')."%' ";
        $this->assign('keyword', $this->request->param('keyword'));
    }
}

/** 指定栏目的文章列表 **/
if(empty($whereSearchTime)){
    $list = DB::table($prefix.$contentTemplateInfo['table_name'])
    ->where($where)->where($whereGet)->where($whereSearchTitle)->where(['status'=>1])->order('sort desc,id desc')
    ->paginate(['list_rows'=>$pageNum,'query' => request()->param()])->each(function($item, $key){
        //循环操作
        return $item;
    });
}
/** 前端调用 **/
<form action="/site-list-3" method="get">
    <input type="text" name="keyword" placeholder="Search by location, postcode or keyword" class="search" />
    <input type="hidden" name="is_search" value="1">
    <input type="hidden" name="model" value="模型名称">
    <input type="submit" value="搜索" class="seach_s" />
</form>
```

## ♬多字段查询

```php
title = "'.$keyword1.'" AND bianhao = "'.$keyword2.'" AND shenfenzheng = "'.$keyword3.'"   <!-- 多字段 -->
/** 区间搜索，一个大于 一个小于 **/
if ($keyword3) {
    $query->where('shoujia', '>=',$keyword3);
}
if ($keyword4) {
    $query->where('shoujia', '<=',$keyword4);
}
-------------------------------------------------------------------------------------------------------------------------------------------------------
//获得搜索结果  /** 这个是满足一个条件就行 精准搜索，下面是必须满足三个条件，替换//获得搜索结果下面 **/
$query = DB::table($prefix.$tableName)->where('status', 1);
if ($keyword1) {
    $query->where('title', $keyword1);
}
if ($keyword2) {
    $query->where('bianhao', $keyword2);
}
if ($keyword3) {
    $query->where('diqu', $keyword3);
}
$list = $query->order('sort desc,id desc')->paginate($pageNum,false,['query' => request()->param()])->each(function($item, $key){
    //循环操作
    return $item;
});

//模糊搜索
 $query = DB::table($prefix.$tableName)->where('status', 1);
if ($keyword1) {
    $query->whereLike('title', '%' . $keyword1 . '%');
}
if ($keyword2) {
    $query->whereLike('Brand', '%' . $keyword2 . '%');
}
if ($keyword3) {
    $query->whereLike('zhongliang', '%' . $keyword3 . '%');
}
if ($keyword4) {
    $query->whereLike('nianfen', '%' . $keyword4 . '%');
}
$list = $query->order('sort desc,id desc')->paginate($pageNum,false,['query' => request()->param()])->each(function($item, $key){
    //循环操作
    return $item;
});

/** 前端调用方法，其他位置和正常搜索一致 **/
<input id="xingming" type="text" name="keyword1" placeholder="请填写考生姓名" class="seach_t" />   
<input id="bianhao" type="text" name="keyword2" placeholder="请填写证书编号" class="seach_t" />
<input id="bianhao" type="text" name="keyword3" placeholder="请填写证书编号" class="seach_t" />

public function zhengshu()
{
    $keyword1 = $this->request->param('keyword1') ?? $this->app->session->get('keyword1');  
    $keyword2 = $this->request->param('keyword2') ?? $this->app->session->get('keyword2');
    $keyword3 = $this->request->param('keyword3') ?? $this->app->session->get('keyword3');
    
    $this->app->session->set('keyword1', $keyword1);
    $this->app->session->set('keyword2', $keyword2);
    $this->app->session->set('keyword3', $keyword3);
    
    $this->assign('keyword1', $keyword1);
    $this->assign('keyword2', $keyword2);
    $this->assign('keyword3', $keyword3);

    $keyword = $this->request->param('keyword')??$this->app->session->get('keyword');
    $this->app->session->set('keyword',$keyword);
    $this->assign('keyword', $keyword);
    $pageNum = $GLOBALS['function']->getConfig()['page_num'];    //获得每页设置显示数量
    $prefix = config("database.connections.mysql.prefix");      //数据表前缀
    $modelName = "";
    if(!isset($_GET['model']) || (isset($_GET['model']) && empty($_GET['model']))){
        //如果没有模型选择，则搜索全部模型
        $tables = DB::query("show tables like '".$prefix."data_article_show_%'");  //搜索所有内容模型数据表
        foreach ($tables AS $key => $value){
            //将所有获得的数据表数组整理成一维数组
            if(array_values($value)[0] != $prefix.'data_article_show_default'){
                //去除默认模型
                $tableArr[] = array_values($value)[0];
            }
        }
        $whereField = "id,cat_id,title,subtitle,create_at,logo,keywords,force_link,template_id";       //获得字段
        $whereUnion = [];
        foreach ($tableArr AS $key => $value){
            //生成与union关联的查询语句
            $whereUnion[] = DB::table($prefix.$value)->alias("a")->field($whereField)->where('title LIKE "%'.$keyword.'%" AND status = 1')->buildSql();
        }

        //生成union子查询语句
        $sqlUnion = DB::table($prefix."data_article_show_default")->alias("a")->field($whereField)
            ->where('title LIKE "%'.$keyword.'%" AND status = 1')
            ->union($whereUnion)->buildSql();
        //获得搜索结果
        $list = DB::table($sqlUnion)->alias("a")
            ->paginate($pageNum,false,['query' => request()->param()])->each(function($item, $key){
                //循环操作
                return $item;
            });
            
    }else{
        //如果有模型选择，则搜索该模型
        $modelName = $_GET['model'];
        $templateInfo = DB::name('DataTemplate')->where(["template_name" => $modelName, 'template_type' => 1])->find();        //内容模型信息
        $tableName = $templateInfo['table_name'];

        //获得搜索结果
        $list = DB::table($prefix.$tableName)
            ->where('title = "'.$keyword1.'" AND bianhao = "'.$keyword2.'" AND shenfenzheng = "'.$keyword3.'"')->where(['status'=>1])->order('sort desc,id desc')
            ->paginate($pageNum,false,['query' => request()->param()])->each(function($item, $key){
                //循环操作
                return $item;
            });
            
    }
    $page = $list->render();
    $this->assign('page', $page);
    $this->assign('articleList',$list);
    $this->assign('modelName',$modelName);
    return $this->fetch('zhengshu');
}
```

## ♬选择时间 进行关键词搜索

```php
<div class="suosou">
    <form action="/site-List-3" method="get">
        <input name="create_at" value="{if isset($create_at)}{$create_at}{/if}" class="seach_t">
        <input type="text" name="keyword" placeholder=""  class="seach_t" value="{if isset($keyword)}{$keyword}{/if}" />
        <input type="hidden" name="is_search" value="1">
        <input type="submit" value="检索" class="seach_s" />
    </form>
</div>
<script>
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        laydate.render({
            elem: '[name="create_at"]'
            ,type: 'year'
        });
    });
</script>

/** article.php **/
$whereSearchTitle = "";
$whereSearchTime = "";
if($this->request->param('is_search')==1){
    // dump($this->request->param('keyword'));die;
    if($this->request->param('keyword')){
        $whereSearchTitle = " title LIKE '%".$this->request->param('keyword')."%' ";
        $this->assign('keyword', $this->request->param('keyword'));
    }
    if($this->request->param('create_at')){
        $whereSearchTime = $this->request->param('create_at');
        $this->assign('create_at', $this->request->param('create_at'));
    }
}
// 指定栏目的文章列表
if(empty($whereSearchTime)){
    $list = DB::table($prefix.$contentTemplateInfo['table_name'])
    ->where($where)->where($whereGet)->where($whereSearchTitle)->where(['status'=>1])->order('sort desc,id desc')
    ->paginate(['list_rows'=>$pageNum,'query' => request()->param()])->each(function($item, $key){
        //循环操作
        return $item;
    });
}else{
    $list = DB::table($prefix.$contentTemplateInfo['table_name'])
    ->where($where)->where($whereGet)->where($whereSearchTitle)->whereYear('create_at', $whereSearchTime)->where(['status'=>1])->order('sort desc,id desc')
    ->paginate(['list_rows'=>$pageNum,'query' => request()->param()])->each(function($item, $key){
        //循环操作
        return $item;
    });
}
```

# 更换富文本

> 将ueditor文件夹复制进 项目目录\public\static\plugs 下
>
> 项目目录/app/data/view/article/article，修改form.html文件

```php
<link href="/public/static/plugs/ueditor/themes/default/css/ueditor.css" type="text/css" rel="stylesheet">
<span class="color-green">内容</span>
<style type="text/css">
    .clear {
        clear: both;
    }
</style>
<textarea id="content" type="text/plain" name="content" style="width:100%;height:500px;">{$vo.content|default=''|raw}</textarea>
```

## ♬js替换为

```php
<script type="text/javascript" charset="utf-8" src="/public/static/plugs/ueditor/ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="/public/static/plugs/ueditor/ueditor.all.min.js"> </script>
<script type="text/javascript" charset="utf-8" src="/public/static/plugs/ueditor/lang/zh-cn/zh-cn.js"></script>
<script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="ZeroClipboard" src="/public/static/plugs/ueditor/third-party/zeroclipboard/ZeroClipboard.js"></script>
<script src="/public/static/plugs/ueditor/third-party/zeroclipboard/ZeroClipboard.js" type="text/javascript" defer="defer"></script>
<script>
    window.form.render();
    UE.delEditor('content');
    var ue = new baidu.editor.ui.Editor({
        initialFrameHeight: 600,
        autoHeightEnabled: false,
        autoFloatEnabled: true
    });
    ue.render('content');
</script>

// 自定义字段
<textarea name="{$field.field_name}"  style="width:100%;height:500px;" id="{$field.field_name}" ><?=isset($vo[$field['field_name']])?$vo[$field['field_name']]:""?></textarea>
<script>
    window.form.render();
    UE.delEditor('{$field.field_name}');//在初始化时把以前的编辑框清除  不能会出现textarea框
    // ueditor 开始调用
    var ue = new baidu.editor.ui.Editor('{$field.field_name}');
    ue.render('{$field.field_name}');
</script>

// content字段不能删除 加class layui-hide  隐藏
// 注意引入的js要放到上面
```

## ♬项目目录/public/static/  修改admin.js文件，替换为

```php
paths: {
    'vue': ['plugs/vue/vue.min'],
    'md5': ['plugs/jquery/md5.min'],
    'json': ['plugs/jquery/json.min'],
    'xlsx': ['plugs/jquery/xlsx.min'],
    'excel': ['plugs/jquery/excel.xlsx'],
    'base64': ['plugs/jquery/base64.min'],
    'upload': [tapiRoot + '/api.upload/index?'],
    'angular': ['plugs/angular/angular.min'],
    'cropper': ['plugs/cropper/cropper.min'],
    'echarts': ['plugs/echarts/echarts.min'],
    'ckeditor': ['plugs/ckeditor/ckeditor'],
    'websocket': ['plugs/socket/websocket'],
    'pcasunzips': ['plugs/jquery/pcasunzips'],
    'sortablejs': ['plugs/sortable/sortable.min'],
    'vue.sortable': ['plugs/sortable/vue.draggable.min'],
    'jquery.ztree': ['plugs/ztree/ztree.all.min'],
    'jquery.masonry': ['plugs/jquery/masonry.min'],
    'jquery.cropper': ['plugs/cropper/cropper.min'],
    'jquery.autocompleter': ['plugs/jquery/autocompleter.min'],
    'ZeroClipboard': ['plugs/ueditor/third-party/zeroclipboard/ZeroClipboard'],
},
```

## ♬自定义工具栏

```php
toolbars: [[
    // 基础功能
    'fullscreen',    // 全屏
    'source',        // 源代码
    'undo',          // 撤销
    'redo',          // 重做
    'bold',          // 加粗
    'italic',        // 斜体
    'underline',     // 下划线
    'strikethrough', // 删除线
    'subscript',     // 下标
    'superscript',   // 上标
    'removeformat',  // 清除格式
    
    // 字体相关
    'fontfamily',    // 字体
    'fontsize',      // 字号
    'forecolor',     // 文字颜色
    'backcolor',     // 背景颜色
    
    // 段落格式
    'indent',        // 缩进
    'justifyleft',   // 左对齐
    'justifycenter', // 居中对齐
    'justifyright',  // 右对齐
    'justifyjustify',// 两端对齐
    'paragraph',     // 段落格式
    'lineheight',    // 行间距
    
    // 列表
    'insertorderedlist',    // 有序列表
    'insertunorderedlist',  // 无序列表
    
    // 表格
    'inserttable',   // 插入表格
    'mergeright',    // 右合并单元格
    'mergedown',     // 下合并单元格
    'splittorows',   // 拆分成行
    'splittocols',   // 拆分成列
    'splittocells',  // 完全拆分单元格
    'deletecaption', // 删除表格标题
    'inserttitle',   // 插入标题
    'mergecells',    // 合并多个单元格
    'deletetable',   // 删除表格
    
    // 特殊功能
    'link',          // 超链接
    'unlink',        // 取消链接
    'anchor',        // 锚点
    'simpleupload',  // 单图上传
    'insertimage',   // 多图上传
    'insertvideo',   // 视频
    'attachment',    // 附件
    'map',           // 百度地图
    'gmap',          // Google地图
    'insertframe',   // 插入Iframe
    'date',          // 日期
    'time',          // 时间
    
    // 格式化
    'blockquote',    // 引用
    'horizontal',    // 分隔线
    'insertcode',    // 代码语言
    'template',      // 模板
    'touppercase',   // 字母大写
    'tolowercase',   // 字母小写
    
    // 查找替换
    'searchreplace', // 查找替换
    
    // 其他
    'preview',       // 预览
    'print',         // 打印
    'help',          // 帮助
    'drafts',        // 从草稿箱加载
    
    // 分隔符
    '|'             // 分隔符
]]
```

# 获取指定栏目下所有得下级分类

> 搜索【获得指定栏目下所有次级分类图文列表信息，要求所有下级分类必须为同一模型】

```php
/**
 * 获取指定栏目及其所有子级栏目下的文章列表
 * @param int $catId 栏目ID
 * @param int $pageSize 每页数量
 * @param string $sort 排序方式
 */
public function getCatAllArticleRecursive($catId = 0, $pageSize, $sort = 'DESC')
{
    // 获取所有子级栏目ID（包括当前栏目）
    $allCatIds = $this->getAllSubCategories($catId);

    // 获取内容模板ID
    $contentTemplateId = $this->app->db->name('DataArticleCate')
        ->whereIn("id", $allCatIds)
        ->group("content_template_id")
        ->value("content_template_id");

    // 获取模板表名
    $tableName = $this->app->db->name('DataTemplate')
        ->where(["id" => $contentTemplateId])
        ->value("table_name");

    // 设置每页数量
    if (empty($pageSize)) {
        $list = $this->app->db->name($tableName)
            ->where(["status" => 1])
            ->whereIn("cat_id", $allCatIds)
            ->order("sort " . $sort . ",id " . $sort)
            ->select()
            ->toArray();
        
        // 添加URL字段
        foreach ($list as $k => $v) {
            $list[$k]['url'] = "/site-List/show-" . $v['cat_id'] . "-" . $v['id'];
        }
        $page = [];
    } else {
        $pageNum = $pageSize;
        $list = $this->app->db->name($tableName)
            ->where(["status" => 1])
            ->whereIn("cat_id", $allCatIds)
            ->order("sort " . $sort . ",id " . $sort)
            ->paginate($pageNum, false, ['query' => request()->param()])
            ->each(function ($item, $key) {
                $item['url'] = "/site-List/show-" . $item['cat_id'] . "-" . $item['id'];
                return $item;
            });
        $page = $list->render();
    }

    return ['list' => $list, 'page' => $page];
}

/**
 * 递归获取所有子级栏目ID（包括当前栏目）
 * @param int $catId 当前栏目ID
 * @return array 所有子级栏目ID数组
 */
private function getAllSubCategories($catId)
{
    // 查询直接子级栏目ID
    $subCats = $this->app->db->name('DataArticleCate')
        ->where(["parent_id" => $catId])
        ->column('id');
    
    // 初始化子级栏目ID数组，包含当前栏目ID
    $subCatIds = [$catId];

    // 遍历每个子级栏目，递归获取其子级
    foreach ($subCats as $subCat) {
        $subCatIds = array_merge($subCatIds, $this->getAllSubCategories($subCat));
    }

    return array_unique($subCatIds);
}

  /**
 * 获取指定栏目及其所有子级栏目下的文章总数量
 * @param int $catId 栏目ID
 * @return int 文章总数量
 */
public function getCatAllArticleCount($catId = 0)
{
    // 获取所有子级栏目ID
    $allCatIds = $this->getAllSubCategories($catId);

    // 如果没有子级栏目，则只获取当前栏目ID
    if (empty($allCatIds)) {
        $allCatIds = [$catId];
    }

    $contentTemplateId = $this->app->db->name('DataArticleCate')
        ->whereIn("id", $allCatIds)
        ->group("content_template_id")
        ->value("content_template_id");

    $tableName = $this->app->db->name('DataTemplate')
        ->where(["id" => $contentTemplateId])
        ->value("table_name");

    // 获取文章总数量
    $count = $this->app->db->name($tableName)
        ->where(["status" => 1])
        ->whereIn("cat_id", $allCatIds)
        ->count();

    return $count;
}
```

# 分页添加页数跳转

```php
<?php
// +----------------------------------------------------------------------
// | ThinkPHP [ WE CAN DO IT JUST THINK ]
// +----------------------------------------------------------------------
// | Copyright (c) 2006~2019 http://thinkphp.cn All rights reserved.
// +----------------------------------------------------------------------
// | Licensed ( http://www.apache.org/licenses/LICENSE-2.0 )
// +----------------------------------------------------------------------
// | Author: zhangyajun <448901948@qq.com>
// +----------------------------------------------------------------------

namespace think\paginator\driver;

use think\Paginator;

/**
 * Bootstrap 分页驱动
 */
class Bootstrap extends Paginator
{
    /**
     * 总数量
     * @param string $text
     * @return string
     */
    protected function getTotal()
    {
        $total = $this->total()." 条";

        return $this->getDisabledTextWrapper($total);
    }

    /**
     * 首页按钮
     * @param string $text
     * @return string
     */
    protected function getFirstButton(string $text = "首页"): string
    {

        if ($this->currentPage() <= 1) {
            return $this->getActivePageWrapper($text);
        }

        $url = $this->url(
            1
        );

        return $this->getPageLinkWrapper($url, $text);
    }

    /**
     * 末页按钮
     * @param string $text
     * @return string
     */
    protected function getLastButton(string $text = "末页"): string
    {

        if (!$this->hasMore) {
            return $this->getActivePageWrapper($text);
        }

        $url = $this->url(
            $this->lastPage()
        );

        return $this->getPageLinkWrapper($url, $text);
    }

    /**
     * 上一页按钮
     * @param string $text
     * @return string
     */
    protected function getPreviousButton(string $text = "上一页"): string
    {

        if ($this->currentPage() <= 1) {
            return $this->getActivePageWrapper($text);
        }

        $url = $this->url(
            $this->currentPage() - 1
        );

        return $this->getPageLinkWrapper($url, $text);
    }

    /**
     * 下一页按钮
     * @param string $text
     * @return string
     */
    protected function getNextButton(string $text = '下一页'): string
    {
        if (!$this->hasMore) {
            return $this->getActivePageWrapper($text);
        }

        $url = $this->url($this->currentPage() + 1);

        return $this->getPageLinkWrapper($url, $text);
    }

    /**
     * 页码按钮
     * @return string
     */
    protected function getLinks(): string
    {
        if ($this->simple) {
            return '';
        }

        $block = [
            'first'  => null,
            'slider' => null,
            'last'   => null,
        ];

        $side   = 3;
        $window = $side * 2;

        if ($this->lastPage < $window + 6) {
            $block['first'] = $this->getUrlRange(1, $this->lastPage);
        } elseif ($this->currentPage <= $window) {
            $block['first'] = $this->getUrlRange(1, $window + 2);
            $block['last']  = $this->getUrlRange($this->lastPage - 1, $this->lastPage);
        } elseif ($this->currentPage > ($this->lastPage - $window)) {
            $block['first'] = $this->getUrlRange(1, 2);
            $block['last']  = $this->getUrlRange($this->lastPage - ($window + 2), $this->lastPage);
        } else {
            $block['first']  = $this->getUrlRange(1, 2);
            $block['slider'] = $this->getUrlRange($this->currentPage - $side, $this->currentPage + $side);
            $block['last']   = $this->getUrlRange($this->lastPage - 1, $this->lastPage);
        }

        $html = '';

        if (is_array($block['first'])) {
            $html .= $this->getUrlLinks($block['first']);
        }

        if (is_array($block['slider'])) {
            $html .= $this->getDots();
            $html .= $this->getUrlLinks($block['slider']);
        }

        if (is_array($block['last'])) {
            $html .= $this->getDots();
            $html .= $this->getUrlLinks($block['last']);
        }

        return $html;
    }

    /**
     * 渲染分页html
     * @return mixed
     */
    public function render()
    {
        if ($this->hasPages()) {
            if ($this->simple) {
                return sprintf(
                    '<ul class="pager">%s %s</ul>',
                    $this->getPreviousButton(),
                    $this->getNextButton()
                );
            } else {
                return sprintf(
                    '<div class="pagination page">%s %s %s %s %s %s <div class="page-search"><input type="number" min="1" max="%d" class="page-search-input" placeholder="页码"> <button class="page-search-btn">跳转</button></div></div>',
                    $this->getTotal(),
                    $this->getFirstButton(),
                    $this->getPreviousButton(),
                    $this->getLinks(),
                    $this->getNextButton(),
                    $this->getLastButton(),
                    $this->lastPage()
                );
            }
        }
    }

    /**
     * 生成一个可点击的按钮
     *
     * @param  string $url
     * @param  string $page
     * @return string
     */
    protected function getAvailablePageWrapper(string $url, string $page): string
    {
        return '<a href="' . htmlentities($url) . '" class="total">' . $page . '</a>';
    }

    /**
     * 生成一个禁用的按钮
     *
     * @param  string $text
     * @return string
     */
    protected function getDisabledTextWrapper(string $text): string
    {
        return '<span class="total">' . $text . '</span>';
    }

    /**
     * 生成一个激活的按钮
     *
     * @param  string $text
     * @return string
     */
    protected function getActivePageWrapper(string $text): string
    {
        return '<span class="active">' . $text . '</span>';
    }

    /**
     * 生成省略号按钮
     *
     * @return string
     */
    protected function getDots(): string
    {
        return $this->getDisabledTextWrapper('...');
    }

    /**
     * 批量生成页码按钮.
     *
     * @param  array $urls
     * @return string
     */
    protected function getUrlLinks(array $urls): string
    {
        $html = '';

        foreach ($urls as $page => $url) {
            $html .= $this->getPageLinkWrapper($url, $page);
        }

        return $html;
    }

    /**
     * 生成普通页码按钮
     *
     * @param  string $url
     * @param  string    $page
     * @return string
     */
    protected function getPageLinkWrapper(string $url, string $page): string
    {
        if ($this->currentPage() == $page) {
            return $this->getActivePageWrapper($page);
        }

        return $this->getAvailablePageWrapper($url, $page);
    }
}
```

## ♬JS

```php
document.addEventListener('DOMContentLoaded', function() {
    const jumpBtn = document.querySelector('.page-search-btn');
    const pageInput = document.querySelector('.page-search-input');
    if(jumpBtn && pageInput) {
        jumpBtn.addEventListener('click', function() {
            const page = parseInt(pageInput.value);
            const max = parseInt(pageInput.getAttribute('max'));
            if(page && page > 0 && page <= max) {
                let url = new URL(window.location.href);
                url.searchParams.set('page', page);
                window.location.href = url.toString();
            } else {
                alert('请输入有效的页码！');
            }
        });
        pageInput.addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                jumpBtn.click();
            }
        });
    }
});
```

